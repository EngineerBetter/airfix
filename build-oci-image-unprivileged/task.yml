---
platform: linux
image_resource:
  type: registry-image
  source:
    repository: engineerbetter/kaniko

inputs:
- name: dockerfile-repo

outputs:
- name: image

run:
  path: /busybox/sh
  args:
  - -c
  - |
    build_args_flags=""
    for var in $(echo $BUILD_ARGS | sed "s/,/ /g"); do
      build_args_flags="${build_args_flags} --build-arg=${var}"
    done

    target_flag=""
    if [ -n "$TARGET" ]; then
      target_flag="--target ${TARGET}"
    fi

    dockerfile_flag=""
    if [ -n "$DOCKERFILE" ]; then
      dockerfile_flag="--dockerfile ${CONTEXT}/${DOCKERFILE}"
    fi

    /kaniko/executor \
    --no-push \
    --context=dir://dockerfile-repo/${CONTEXT} \
    --tarPath=./image/image.tar \
    --destination=${IMAGE_NAME}:${TAG} \
    ${build_args_flags} \
    ${target_flag} \
    ${dockerfile_flag}

params:
  BUILD_ARGS: #comma-separated list, e.g. foo=bar,foz=baz
  CONTEXT: "."
  DOCKERFILE: Dockerfile
  IMAGE_NAME:
  TAG:
  TARGET:
